# 台湾智能家居 CRM 系统 — 技术架构文档

**版本**: 2.0.0
**日期**: 2026-02-24
**架构路线**: Next.js 全栈一体 + Teable 源码集成

---

## 1. 技术栈总览

| 层级 | 技术 | 版本 | 说明 |
|------|------|------|------|
| **框架** | Next.js | 16.1.6 (stable) | App Router + Turbopack |
| **运行时** | React | 19.2.x | Server Components + Actions |
| **语言** | TypeScript | 5.7+ | 严格模式 |
| **包管理** | pnpm | 10.29.x | workspace 模式 |
| **构建** | Turbopack | 内置 | `next dev --turbo` |
| **ORM** | Prisma | 7.4.x | TypeScript 重写，3x 更快 |
| **数据库** | PostgreSQL | 17 | Multi-Schema 隔离 |
| **缓存/队列** | Redis | 7.x | Session + Cache + BullMQ |
| **对象存储** | MinIO | latest | S3 兼容 |
| **认证** | Auth.js | v5 (next-auth@5) | 自建，不依赖 Clerk |
| **权限** | 自建 RBAC | - | Prisma 模型 + Middleware |
| **CSS** | Tailwind CSS | 4.2.x | CSS-first 配置 |
| **UI 组件** | Shadcn UI | latest | Zinc 主题 |
| **状态管理** | Zustand | 5.x | UI 状态 |
| **URL 状态** | Nuqs | latest | 搜索/过滤/分页参数 |
| **表格** | TanStack Table | 8.x | 服务端分页 |
| **表单** | React Hook Form | 7.x | + Zod 4 校验 |
| **图表** | Recharts | 3.x | 数据可视化 |
| **动画** | tw-animate-css | latest | Tailwind 动画 |
| **文档编辑器** | BlockNote | latest | Notion 风格块编辑器，基于 Tiptap/ProseMirror |
| **国际化** | next-intl | 4.x | 用户级语言偏好 |
| **表格系统** | Teable | latest | 开源 Airtable，原生 PG 表，源码集成 |
| **实时通信** | Socket.IO | latest | WebSocket + Redis Pub/Sub |

---

## 2. 系统架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────┐
│                   浏览器                         │
│  Portal (:3000)          Teable (:3001)         │
│  CRM 业务界面             表格/看板/日历          │
│  Shadcn UI               Teable UI              │
└──────────┬───────────────────┬──────────────────┘
           │                   │
  Server Actions          NestJS API
           │                   │
┌──────────┴───────────────────┴──────────────────┐
│              pnpm monorepo (源码)                │
│                                                  │
│  apps/portal (Next.js 16)  apps/teable (源码)   │
│  ┌──────────┐              ┌──────────┐         │
│  │ Auth.js  │              │ NestJS   │         │
│  │ RBAC     │              │ Backend  │         │
│  │ BullMQ   │              │          │         │
│  └────┬─────┘              └────┬─────┘         │
│       └────────────┬────────────┘               │
│              ┌─────┴─────┐                      │
│              │ Prisma 7  │  ← 共享 packages/db  │
│              └─────┬─────┘                      │
└────────────────────┼────────────────────────────┘
                     │
        ┌────────────┼────────────┐
   ┌────┴────┐  ┌────┴────┐  ┌───┴─────┐
   │ PG 17   │  │ Redis 7 │  │ MinIO   │
   │ :5433   │  │ :6379   │  │ :9000   │
   └─────────┘  └─────────┘  └─────────┘
   192.168.110.246（已有基础设施）
```

### 2.2 Teable 在系统中的角色（源码集成）

Teable 以源码形式集成到 monorepo，与 Portal 共享同一个 PostgreSQL（每张表 = 真实 PG 表）：

| 职责 | Portal (Next.js + Prisma) | Teable (源码) |
|------|---------------------------|---------------|
| 核心业务逻辑 | ✅ Server Actions | ❌ |
| 数据 CRUD | ✅ Prisma 7 | ✅ REST API |
| 复杂查询/报表 | ✅ Raw SQL | ✅ SQL 查询 |
| 数据可视化管理 | ❌ | ✅ 表格/看板/日历/画廊视图 |
| 数据导入导出 | ❌ | ✅ CSV/Excel/JSON |
| 非开发人员操作 | ❌ | ✅ 无代码界面 |
| 百万行性能 | ✅ | ✅ ~200ms |
| 实时协作 | ❌ | ✅ 多人同时编辑 |

**源码集成的优势**：
- 可添加繁体中文 (`zh-TW`) 到 Teable 的 `common-i18n` 包
- 可定制 Teable UI 风格，与 Portal 保持一致
- 可对接自建 Auth.js + RBAC，替换 Teable 自带认证
- 可开发自定义插件 (`plugins/`)
- Portal 和 Teable 共享 `packages/db` (Prisma schema)
- 开发时 `pnpm dev` 一起启动，不需要 Docker

---

## 3. 项目结构

```
TWCRM/
├── pnpm-workspace.yaml       # pnpm workspace 配置
├── package.json               # Root package
├── turbo.json                 # Turborepo 任务配置
├── docker-compose.yml         # PG + Redis + MinIO（基础设施备用）
├── .env                       # 环境变量
│
├── apps/
│   ├── portal/                # CRM 主应用 (Next.js 16)
│   │   ├── package.json
│   │   ├── next.config.ts
│   │   ├── tsconfig.json
│   │   ├── public/
│   │   └── src/
│   │       ├── app/           # App Router 路由
│   │       │   ├── (auth)/    # 登录/注册
│   │       │   ├── (dashboard)/  # 后台主体
│   │       │   │   ├── layout.tsx
│   │       │   │   ├── dashboard/
│   │       │   │   ├── customers/     # 客户管理
│   │       │   │   ├── opportunities/ # 商机管理
│   │       │   │   ├── contracts/     # 合同管理
│   │       │   │   ├── products/      # 产品管理(智能家居)
│   │       │   │   ├── workorders/    # 安装工单
│   │       │   │   ├── analytics/     # 数据分析
│   │       │   │   ├── ordering/      # 子公司订货
│   │       │   │   ├── inventory/     # 进销存（占位）
│   │       │   │   ├── learning/      # 培训（占位）
│   │       │   │   ├── finance/       # 财务（占位）
│   │       │   │   ├── okr/           # OKR（占位）
│   │       │   │   ├── docs/          # 文档知识库
│   │       │   │   ├── settings/      # 系统设置
│   │       │   │   └── platform/      # 总部管理
│   │       │   └── api/
│   │       ├── features/      # 业务模块 (Feature-based)
│   │       │   ├── customers/
│   │       │   │   ├── components/
│   │       │   │   ├── actions/
│   │       │   │   ├── services/
│   │       │   │   ├── repositories/
│   │       │   │   ├── hooks/
│   │       │   │   ├── schemas/
│   │       │   │   ├── events/
│   │       │   │   └── types/
│   │       │   ├── ordering/
│   │       │   ├── opportunities/
│   │       │   ├── contracts/
│   │       │   ├── products/
│   │       │   ├── workorders/
│   │       │   ├── analytics/
│   │       │   └── docs/
│   │       ├── components/    # 共享组件
│   │       │   ├── ui/        # Shadcn UI
│   │       │   └── layout/    # Shell/Sidebar/Header
│   │       ├── config/        # 导航/主题配置
│   │       ├── hooks/         # 全局 Hooks
│   │       ├── lib/           # 工具函数
│   │       ├── messages/      # i18n 语言文件
│   │       │   ├── zh-CN.json
│   │       │   ├── zh-TW.json
│   │       │   └── en.json
│   │       ├── stores/        # Zustand stores
│   │       └── types/         # TypeScript 类型
│   │
│   └── teable/                # Teable 表格系统（源码集成）
│       ├── nextjs-app/        # Teable 前端 (Next.js)
│       ├── nestjs-backend/    # Teable 后端 (NestJS)
│       └── plugins/           # Teable 插件
│
├── packages/
│   ├── db/                    # Prisma 7 + Schema（Portal 与 Teable 共享）
│   │   ├── prisma/
│   │   │   └── schema.prisma  # Multi-Schema
│   │   └── src/
│   ├── auth/                  # Auth.js v5 配置
│   ├── rbac/                  # RBAC 权限系统
│   ├── redis/                 # Redis 客户端
│   ├── storage/               # MinIO 客户端
│   ├── ui/                    # 共享 UI 组件
│   └── tailwind-config/       # Tailwind 配置
│
├── skills/                    # Cursor Skills
├── openspec/                  # OpenSpec 规范驱动
└── doc/                       # 文档
```

---

## 4. 数据库设计

### 4.1 Multi-Schema 隔离

| Schema | 用途 | 管理方 |
|--------|------|--------|
| `auth` | 用户/角色/权限/租户/Session | Portal |
| `crm` | 客户/商机/合同/联系人/工单 | Portal |
| `ordering` | 产品目录/订单/余额/物流 | Portal |
| `inventory` | 仓库/库存/SN码/采购/调拨 | Portal |
| `finance` | 收款/付款/发票 | Portal |
| `okr` | OKR/KPI/项目/任务/TodoList | Portal |
| `docs` | 文档/权限/引用 | Portal |
| `lms` | 课程/章节/考试/证书/进度 | Portal |
| `teable` | Teable 内部元数据 | Teable 自动管理 |

### 4.2 Prisma 7 配置

```prisma
generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth", "crm", "ordering", "inventory", "finance", "okr", "docs", "lms"]
}
```

---

## 5. 认证与权限

### 5.1 Auth.js v5 配置

- 自建认证，不依赖 Clerk/Directus
- JWT Session 策略
- Session 中包含：id, email, name, tenantId, role, locale
- Redis 存储 Session

### 5.2 自建 RBAC

角色层级：

| 角色 | 数据范围 | 说明 |
|------|----------|------|
| `platform_admin` | 所有租户 | 总部超级管理员 |
| `platform_viewer` | 所有租户（只读） | 总部查看者，大屏用 |
| `tenant_admin` | 本租户 | 子公司管理员 |
| `tenant_manager` | 本租户 | 子公司经理 |
| `tenant_user` | 本租户 | 子公司普通员工 |

权限格式：`{module}:{action}`（如 `order:create`, `customer:read`）

---

## 6. WebSocket 实时系统

### 6.1 技术方案

- Socket.IO (Server + Client)
- Redis Pub/Sub（多实例广播）
- Auth.js Session Token 认证

### 6.2 事件列表

| 事件 | 方向 | 说明 |
|------|------|------|
| `order:new` | Server → Client | 新订单通知（总部） |
| `order:status_changed` | Server → Client | 订单状态变更（子公司） |
| `order:shipped` | Server → Client | 发货通知（子公司） |
| `stock:low` | Server → Client | 库存预警（总部） |
| `stock:updated` | Server → Client | 库存变更 |
| `workorder:assigned` | Server → Client | 工单指派通知 |
| `workorder:completed` | Server → Client | 工单完成通知 |
| `notification:new` | Server → Client | 系统通知 |

### 6.3 房间设计

| 房间 | 加入条件 | 用途 |
|------|----------|------|
| `platform` | platform_admin 角色 | 总部接收所有事件 |
| `tenant:{tenantId}` | 该租户的所有用户 | 子公司内部事件 |
| `user:{userId}` | 个人 | 个人通知/待办提醒 |

---

## 7. 基础设施

基础设施已部署在 `192.168.110.246`：

| 服务 | 端口 | 用途 | 部署方式 |
|------|------|------|----------|
| PostgreSQL 17 | 5433 | 主数据库 | 已有服务器 |
| Redis 7 | 6379 | 缓存/Session/队列 | 已有服务器 |
| MinIO | 9000/9001 | 文件存储 | 已有服务器 |
| Portal | 3000 | CRM 主应用 | 源码 `pnpm dev` |
| Teable | 3001 | 表格系统 | 源码 `pnpm dev` |

---

## 8. 版本锁定

```
next:           16.1.6
react:          19.2.x
typescript:     5.7.x
prisma:         7.4.x
tailwindcss:    4.2.x
next-auth:      5.x (Auth.js v5)
pnpm:           10.29.x
zustand:        5.x
zod:            4.x
@tanstack/react-table: 8.x
react-hook-form: 7.x
recharts:       3.x
teable:         latest
next-intl:      4.x
blocknote:      latest (基于 Tiptap/ProseMirror)
socket.io:      latest
```

---

## 9. 国际化 (i18n) — 用户级语言偏好

### 9.1 支持语言

| 代码 | 语言 | 说明 |
|------|------|------|
| `zh-CN` | 简体中文 | 默认语言 |
| `zh-TW` | 繁体中文 | |
| `en` | English | |

### 9.2 技术方案

- 库：`next-intl`（Next.js App Router 原生支持）
- 语言文件：`src/messages/zh-CN.json`、`zh-TW.json`、`en.json`

### 9.3 用户级偏好（非全局切换）

```
用户登录 → 读取 DB 中 user.locale 字段 → 设置语言
用户在「设置」页切换语言 → 写入 DB → Cookie 同步 → 页面刷新生效
```

- 每个用户独立设置，存储在 `auth.user` 表的 `locale` 字段
- 未登录时默认 `zh-CN`
- 语言偏好通过 Cookie (`NEXT_LOCALE`) 传递给 Server Components
- 所有 UI 文案、表单标签、错误提示、菜单名称均走 i18n

### 9.4 数据库字段

```prisma
model User {
  // ...
  locale  String @default("zh-CN") // zh-CN | zh-TW | en
}
```

---

## 10. 文档/知识库模块（自建）

### 10.1 技术选型

| 组件 | 技术 | 说明 |
|------|------|------|
| 编辑器 | BlockNote | 9k stars，Notion 风格开箱即用，底层基于 Tiptap/ProseMirror |
| 视频播放 | BlockNote 内置 Video Block | 支持上传视频(MinIO) + 嵌入外部视频 |
| 跨模块引用 | BlockNote Mention + 自定义触发符 | `@客户`、`#工单`、`$产品` 等，点击跳转 |
| 协作编辑 | BlockNote + Yjs | 可选，后期加入 |
| 数据存储 | Prisma + PostgreSQL (JSON) | 编辑器内容存为 BlockNote JSON |
| 文件上传 | MinIO (S3) | 视频、图片、附件统一存储 |

### 10.2 Notion 风格交互

BlockNote 开箱即用的 Notion 体验：
- `/` 斜杠命令 — 输入 `/` 弹出 Block 类型菜单
- `⋮⋮` 拖拽手柄 — 每个 Block 左侧可拖拽排序
- `+` 添加按钮 — 快速在任意位置插入新 Block
- Block 类型转换 — 段落 ↔ 标题 ↔ 列表 ↔ 引用
- 嵌套 Block — 缩进、Toggle list
- 内联工具栏 — 选中文字弹出格式化工具
- Light/Dark 主题

### 10.3 核心功能

**内置 Block 类型：**
- 标题 (H1/H2/H3)、段落、列表（有序/无序/待办）
- 图片 Block（拖拽/粘贴上传 → MinIO）
- 视频 Block（上传到 MinIO 或粘贴外部链接）
- 音频 Block、文件附件 Block
- 表格、代码块、引用、分割线

**跨模块引用（Mention 系统）：**
```
@  → 搜索用户/员工        → 跳转到员工详情
#  → 搜索工单/商机        → 跳转到工单/商机页面
$  → 搜索产品(智能家居)   → 跳转到产品详情
&  → 搜索客户/公司        → 跳转到客户详情
!  → 搜索其他文档         → 跳转到文档页面
```

### 10.4 数据模型

```prisma
model Document {
  id          String     @id @default(cuid())
  title       String
  content     Json       // BlockNote JSON 内容
  parentId    String?
  parent      Document?  @relation("DocTree", fields: [parentId], references: [id])
  children    Document[] @relation("DocTree")
  sortOrder   Int        @default(0)
  isPublished Boolean    @default(false)
  visibility  String     @default("private") // private | team | department | public
  createdBy   String
  updatedBy   String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  mentions    DocumentMention[]
  permissions DocumentPermission[]

  @@schema("docs")
}

model DocumentPermission {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id])
  userId     String?
  roleId     String?
  deptId     String?
  level      String   // view | comment | edit | admin
  createdAt  DateTime @default(now())

  @@unique([documentId, userId])
  @@schema("docs")
}

model DocumentMention {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id])
  module     String   // customers | workorders | products | docs
  targetId   String
  createdAt  DateTime @default(now())

  @@unique([documentId, module, targetId])
  @@schema("docs")
}
```

### 10.5 文档权限模型

| 级别 | 能力 |
|------|------|
| `view` | 只读 |
| `comment` | 只读 + 可评论 |
| `edit` | 可编辑 |
| `admin` | 可编辑 + 管理权限 + 删除 |

---

## 11. 多租户架构（集团 → 子公司模式）

### 11.1 业务模型

```
┌─────────────────────────────────────────────┐
│              总部 (Platform)                 │
│   可查看所有子公司数据 + 大屏汇总报表         │
└──────────────────┬──────────────────────────┘
                   │
     ┌─────────────┼─────────────┐
     │             │             │
┌────┴────┐  ┌────┴────┐  ┌────┴────┐
│ 子公司A  │  │ 子公司B  │  │ 子公司C  │
│ 台北分部  │  │ 台中分部  │  │ 高雄分部  │
│ 数据隔离  │  │ 数据隔离  │  │ 数据隔离  │
└─────────┘  └─────────┘  └─────────┘
```

### 11.2 数据隔离方式：行级隔离 (Row-Level)

所有租户共享同一套表，通过 `tenantId` 字段区分：

```prisma
model Tenant {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique // TW-TPE
  logo      String?
  status    String   @default("active")
  parentId  String?
  parent    Tenant?  @relation("TenantTree", fields: [parentId], references: [id])
  children  Tenant[] @relation("TenantTree")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("auth")
}
```

### 11.3 数据查询策略

- **子公司用户**：Prisma Middleware 自动注入 `WHERE tenantId = ?`
- **总部用户**：不注入 tenantId，查全部数据
- **大屏汇总**：`groupBy(['tenantId'])` 按子公司聚合

### 11.4 总部大屏

路由：`/platform/dashboard`，汇总所有子公司数据（客户数、商机额、成交额、工单完成率等）

---

## 12. 培训 LMS 模块

### 12.1 设计理念

课程 = **有序的章节集合**，章节 = **BlockNote 文档 + 视频**，复用文档模块编辑器。

### 12.2 功能清单

| 功能 | 说明 |
|------|------|
| 课程管理 | 总部创建/编辑/发布，支持分类 |
| 章节编辑 | BlockNote 编辑器，支持视频、图文、附件 |
| 发布控制 | 草稿 → 审核 → 发布 |
| 指派学习 | 总部指派给子公司/角色/员工，设置截止日期 |
| 学习进度 | 章节完成状态、视频观看进度 |
| 考试/测验 | 单选、多选、判断、简答 |
| 证书发放 | 考试通过自动生成 PDF 证书（@react-pdf/renderer → MinIO） |
| 学习报表 | 各子公司学习完成率、考试通过率 |

### 12.3 数据模型

```prisma
model Course {
  id          String   @id @default(cuid())
  tenantId    String?  // null = 总部课程（全局可见）
  title       String
  description String?
  coverImage  String?
  category    String   // product | service | sales | compliance
  status      String   @default("draft") // draft | review | published
  passingScore Int     @default(60)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  chapters    Chapter[]
  assignments CourseAssignment[]
  @@schema("lms")
}

model Chapter {
  id        String  @id @default(cuid())
  courseId  String
  course    Course  @relation(fields: [courseId], references: [id])
  title     String
  content   Json    // BlockNote JSON
  sortOrder Int     @default(0)
  quiz      Quiz?
  @@schema("lms")
}

model CourseAssignment {
  id        String    @id @default(cuid())
  courseId  String
  course    Course    @relation(fields: [courseId], references: [id])
  tenantId  String?
  roleId    String?
  userId    String?
  dueDate   DateTime?
  createdAt DateTime  @default(now())
  @@schema("lms")
}

model LearningProgress {
  id          String   @id @default(cuid())
  userId      String
  courseId    String
  chapterId   String
  completed   Boolean  @default(false)
  videoProgress Int    @default(0)
  updatedAt   DateTime @updatedAt
  @@unique([userId, chapterId])
  @@schema("lms")
}

model Quiz {
  id        String     @id @default(cuid())
  chapterId String?    @unique
  courseId  String?
  title     String
  questions Question[]
  attempts  QuizAttempt[]
  @@schema("lms")
}

model Question {
  id       String @id @default(cuid())
  quizId   String
  quiz     Quiz   @relation(fields: [quizId], references: [id])
  type     String // single | multiple | boolean | text
  content  String
  options  Json?
  answer   Json
  score    Int    @default(10)
  sortOrder Int   @default(0)
  @@schema("lms")
}

model QuizAttempt {
  id        String   @id @default(cuid())
  quizId    String
  quiz      Quiz     @relation(fields: [quizId], references: [id])
  userId    String
  answers   Json
  score     Int
  passed    Boolean
  createdAt DateTime @default(now())
  @@schema("lms")
}

model Certificate {
  id       String   @id @default(cuid())
  userId   String
  courseId String
  score    Int
  issuedAt DateTime @default(now())
  pdfUrl   String?
  @@unique([userId, courseId])
  @@schema("lms")
}
```

---

## 13. 进销存模块（WMS/IMS）

### 13.1 业务流程

```
供应商 → 采购入库（总仓）→ 调拨出库 → 子公司仓库 → 安装工单领料 → 扣库存
```

### 13.2 功能清单

| 功能 | 说明 |
|------|------|
| 产品档案 | SKU 管理（型号/规格/品牌） |
| SN 码管理 | 每台设备唯一序列号，全生命周期追踪 |
| 采购管理 | 采购单 → 供应商发货 → 入库确认 |
| 库存查询 | 各仓库实时库存 |
| 调拨管理 | 子公司申请 → 总仓审批 → 出库 → 子公司入库 |
| 工单领料 | 安装工单完成自动扣库存 |
| 库存预警 | 低于安全库存自动提醒 |

### 13.3 数据模型

```prisma
model Warehouse {
  id        String  @id @default(cuid())
  tenantId  String?
  name      String
  address   String?
  isMain    Boolean @default(false)
  stocks    Stock[]
  @@schema("inventory")
}

model Product {
  id          String  @id @default(cuid())
  tenantId    String?
  sku         String  @unique
  name        String
  brand       String?
  category    String  // curtain | lock | light | sensor | gateway
  unit        String  @default("台")
  safetyStock Int     @default(0)
  specs       Json?
  stocks      Stock[]
  snCodes     SnCode[]
  @@schema("inventory")
}

model Stock {
  id          String    @id @default(cuid())
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  quantity    Int       @default(0)
  updatedAt   DateTime  @updatedAt
  @@unique([productId, warehouseId])
  @@schema("inventory")
}

model SnCode {
  id          String    @id @default(cuid())
  sn          String    @unique
  productId   String
  product     Product   @relation(fields: [productId], references: [id])
  warehouseId String?
  status      String    @default("in_stock")
  // in_stock | allocated | installed | returned | scrapped
  customerId  String?
  workOrderId String?
  installedAt DateTime?
  createdAt   DateTime  @default(now())
  @@schema("inventory")
}
```

### 13.4 工单自动扣库存

安装工单完成时：Prisma 事务保证原子性 → 扣减库存 → 更新 SN 码状态 → 绑定客户 → 完成工单。

---

## 14. 财务模块

### 14.1 功能清单

| 功能 | 说明 |
|------|------|
| 收款管理 | 客户合同付款记录、到账确认、逾期提醒 |
| 付款管理 | 给供应商付款记录、付款申请审批 |
| 发票管理 | 开具发票（给客户）、收取发票（来自供应商）|
| 财务报表 | 收支汇总、利润分析、各子公司财务对比 |
| 电子发票 | 接口预留（暂不实现，后期对接台湾财政部 API）|

### 14.2 数据模型

```prisma
model Payment {
  id           String   @id @default(cuid())
  tenantId     String
  contractId   String
  customerId   String
  amount       Decimal  @db.Decimal(12, 2)
  currency     String   @default("TWD")
  paidAt       DateTime
  method       String   // cash | transfer | check | credit_card
  status       String   @default("pending") // pending | confirmed | refunded
  invoiceId    String?
  note         String?
  createdAt    DateTime @default(now())
  @@schema("finance")
}

model Disbursement {
  id          String   @id @default(cuid())
  tenantId    String
  supplier    String
  purchaseId  String?
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("TWD")
  paidAt      DateTime?
  method      String
  status      String   @default("pending") // pending | approved | paid | rejected
  requestedBy String
  approvedBy  String?
  createdAt   DateTime @default(now())
  @@schema("finance")
}

model Invoice {
  id          String   @id @default(cuid())
  tenantId    String
  type        String   // issued | received
  invoiceNo   String   @unique
  amount      Decimal  @db.Decimal(12, 2)
  taxAmount   Decimal  @db.Decimal(12, 2) @default(0)
  issueDate   DateTime
  status      String   @default("draft") // draft | issued | paid | void
  fileUrl     String?
  einvoiceNo  String?  // 台湾电子发票号（预留）
  createdAt   DateTime @default(now())
  @@schema("finance")
}
```

---

## 15. OKR + KPI + 项目管理 + TodoList 模块

### 15.1 闭环设计

```
总部设定 OKR（季度目标）
    ↓ 分解为 KPI（自动从业务数据拉取）
    ↓ 拆解为项目任务（看板/甘特图）
    ↓ 落地为个人 TodoList（每日待办）
    ↓ 完成数据回流 → KPI 自动更新 → OKR 进度自动计算
```

### 15.2 KPI 自动同步指标

| metric | 数据来源 | 说明 |
|--------|----------|------|
| `crm.contracts.count` | CRM 合同表 | 新签合同数 |
| `crm.contracts.amount` | CRM 合同表 | 合同总金额 |
| `crm.customers.new` | CRM 客户表 | 新增客户数 |
| `crm.opportunities.won_rate` | CRM 商机表 | 商机赢单率 |
| `workorder.completed.count` | 工单表 | 完成工单数 |
| `inventory.sales.amount` | 进销存 | 产品销售额 |
| `finance.payment.amount` | 财务收款 | 实收款金额 |

KPI 自动同步通过 BullMQ 定时任务每天凌晨执行。

### 15.3 前端视图

| 视图 | 说明 |
|------|------|
| OKR 树形图 | 公司 → 部门 → 个人 OKR 层级展示 |
| KPI 仪表盘 | 各指标当前值 vs 目标值 |
| 项目看板 | 拖拽卡片（dnd-kit） |
| 甘特图 | 任务时间线 |
| 个人 TodoList | 今日待办，快速勾选 |

### 15.4 TodoList 关联

TodoList 可关联到：项目任务、CRM 商机跟进、安装工单、客户。

---

## 16. 子公司订货系统（B2B 内部电商）— 第一期优先

### 16.1 业务流程

```
子公司登录 → 浏览产品目录 → 加入购物车 → 提交订单
    ↓ 系统检查余额 → 余额足够 → 自动扣款 → 订单生成
    ↓ 总部后台看到新订单 → 备货 → 填写物流单号 → 发货
    ↓ 子公司查看物流状态 → 确认收货 → 库存入库
```

### 16.2 功能清单

| 功能 | 说明 |
|------|------|
| 产品目录 | 总部维护，分类浏览 |
| 子公司专属价格 | 不同子公司不同价格，支持多币种/汇率 |
| MOQ 配置 | 每个产品可设最小起订量（可配置，不硬编码） |
| 定制产品提示 | 定制类产品下单时显示提示信息/备注栏 |
| 购物车 | 选品、改数量、小计金额 |
| 余额支付 | 余额够自动通过，不够提示充值 |
| 在线支付 | 预留接口，后续开放 |
| 订单管理 | 子公司查看订单列表/详情/状态 |
| 物流追踪 | 总部填写物流单号，子公司查看物流状态 |
| 确认收货 | 子公司确认后库存自动入库 |
| 余额管理 | 总部给子公司充值，子公司查看余额/流水 |

### 16.3 数据模型

```prisma
// 产品目录
model CatalogProduct {
  id          String   @id @default(cuid())
  categoryId  String
  sku         String   @unique
  name        String
  description String?
  images      String[]
  specs       Json?
  basePrice   Decimal  @db.Decimal(12, 2)
  currency    String   @default("TWD")
  moq         Int      @default(1)
  stock       Int      @default(0)
  isCustom    Boolean  @default(false)
  customNote  String?
  status      String   @default("active")
  prices      TenantPrice[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  @@schema("ordering")
}

// 子公司专属价格
model TenantPrice {
  id        String  @id @default(cuid())
  productId String
  product   CatalogProduct @relation(fields: [productId], references: [id])
  tenantId  String
  price     Decimal @db.Decimal(12, 2)
  currency  String  @default("TWD")
  @@unique([productId, tenantId])
  @@schema("ordering")
}

// 汇率配置
model ExchangeRate {
  id       String  @id @default(cuid())
  from     String
  to       String
  rate     Decimal @db.Decimal(10, 6)
  updatedAt DateTime @updatedAt
  @@unique([from, to])
  @@schema("ordering")
}

// 子公司余额
model TenantAccount {
  id        String  @id @default(cuid())
  tenantId  String  @unique
  balance   Decimal @db.Decimal(12, 2) @default(0)
  currency  String  @default("TWD")
  updatedAt DateTime @updatedAt
  transactions AccountTransaction[]
  @@schema("ordering")
}

model AccountTransaction {
  id        String  @id @default(cuid())
  accountId String
  account   TenantAccount @relation(fields: [accountId], references: [id])
  type      String  // topup | deduct | refund
  amount    Decimal @db.Decimal(12, 2)
  orderId   String?
  note      String?
  createdBy String
  createdAt DateTime @default(now())
  @@schema("ordering")
}

// 订单
model Order {
  id          String   @id @default(cuid())
  orderNo     String   @unique
  tenantId    String
  totalAmount Decimal  @db.Decimal(12, 2)
  currency    String   @default("TWD")
  status      String   @default("pending")
  // pending → paid → processing → shipped → delivered → completed
  remark      String?
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  items       OrderItem[]
  shipment    Shipment?
  @@index([tenantId])
  @@schema("ordering")
}

model OrderItem {
  id        String @id @default(cuid())
  orderId   String
  order     Order  @relation(fields: [orderId], references: [id])
  productId String
  sku       String
  name      String
  price     Decimal @db.Decimal(12, 2)
  quantity  Int
  subtotal  Decimal @db.Decimal(12, 2)
  @@schema("ordering")
}

// 物流
model Shipment {
  id            String   @id @default(cuid())
  orderId       String   @unique
  order         Order    @relation(fields: [orderId], references: [id])
  carrier       String?
  trackingNo    String?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  status        String   @default("pending")
  // pending → shipped → in_transit → delivered
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  @@schema("ordering")
}
```

### 16.4 子公司前台页面

| 页面 | 路由 |
|------|------|
| 产品目录 | `/ordering` |
| 购物车 | `/ordering/cart` |
| 我的订单 | `/ordering/orders` |
| 订单详情 | `/ordering/orders/[id]` |
| 我的余额 | `/ordering/account` |

### 16.5 总部后台页面

| 页面 | 路由 |
|------|------|
| 产品管理 | `/platform/products` |
| 价格管理 | `/platform/pricing` |
| 订单管理 | `/platform/orders` |
| 发货管理 | `/platform/shipments` |
| 余额管理 | `/platform/accounts` |

---

## 17. 模块分期计划

| 阶段 | 模块 | 方式 | 说明 |
|------|------|------|------|
| **第一期（优先）** | 多租户 + 认证 + RBAC | 自建 | 基础设施，所有模块依赖 |
| **第一期（优先）** | 子公司订货系统 | 自建 | 产品目录/购物车/下单/余额/发货/物流 |
| 第一期 | CRM 核心 + Teable | 自建 | 客户/商机/合同/产品/工单/Dashboard |
| 第一期 | 文档/知识库 | 自建 (BlockNote) | 含视频、跨模块引用、权限 |
| 第一期 | 总部大屏 | 自建 (Recharts) | 汇总所有子公司数据 |
| 第一期 | 其他模块占位页 | 占位 | 路由+菜单+权限预定义 |
| 第二期 | 进销存 | 自建 | 多仓库/SN码/采购/调拨/工单自动扣库存 |
| 第二期 | 培训 LMS | 自建（复用 BlockNote） | 课程/进度/考试/证书，总部发布 |
| 第三期 | 财务 | 自建 | 收款/付款/发票/报表，电子发票接口预留 |
| 第三期 | OKR/KPI/项目管理/TodoList | 自建 | 四合一闭环，KPI 自动从业务数据同步 |

---

## 18. 变更日志

| 版本 | 日期 | 变更 |
|------|------|------|
| 2.0.0 | 2026-02-24 | 重新生成完整文档，NocoDB→Teable，Directus→自建RBAC，新增订货/LMS/进销存/财务/OKR/文档/多租户/WebSocket/i18n |
